name: ESO Addon Release

# Ausl√∂ser: Bei einem Pull Request auf die master-Branch von development oder manuellem dispatch
on:
  pull_request:
    branches:
      - master
    types:
      - closed
  workflow_dispatch:

jobs:
  build:
    if: (github.event.pull_request.merged == true && github.event.pull_request.base.ref == 'master' && github.event.pull_request.head.ref == 'development') || (github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        path: 'barnysCCTracker'

    - name: Extract API Version and Addon Version
      id: version_info
      run: |
        APIVersion=$(grep -Po '(?<=## APIVersion: )\d+' barnysCCTracker/barnysCCTracker.txt)
        AddonVersion=$(grep -Po '(?<=## Version: )[\d.]+' barnysCCTracker/barnysCCTracker.txt)
        echo "API_VERSION=$APIVersion" >> $GITHUB_ENV
        echo "ADDON_VERSION=$AddonVersion" >> $GITHUB_ENV

    - name: Extract Changelog
      id: changelog
      run: |
        Changelog=$(cat barnysCCTracker/Changelog.txt)
        echo "CHANGELOG<<EOF" >> $GITHUB_ENV
        echo "$Changelog" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Extract Addon Description
      id: description
      run: |
        Description=$(cat barnysCCTracker/README.md)
        # URL-encode the description to avoid issues with special characters
        URLEncodedDescription=$(echo "$Description" | jq -sRr @uri)
        echo "DESCRIPTION<<EOF" >> $GITHUB_ENV
        echo "$URLEncodedDescription" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Zip Addon Files (excluding .gitattributes)
      run: 7z a barnysCCTracker.zip barnysCCTracker/* -xr!*.gitattributes

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.CREATE_RELEASE_TOKEN }}
      with:
        tag_name: ${{ env.ADDON_VERSION }}
        name: Release ${{ env.ADDON_VERSION }}
        body: ${{ env.CHANGELOG }}
        draft: false
        prerelease: false

    - name: Upload Addon to ESOUI
      run: |
        curl -X POST "https://api.esoui.com/addons/update" \
          -H "x-api-token: ${{ secrets.ESOUI_API_TOKEN }}" \
          -F "id=3971" \
          -F "version=${{ env.ADDON_VERSION }}" \
          -F "updatefile=@./barnysCCTracker.zip" \
          -F "changelog=${{ env.CHANGELOG }}" \
          -F "compatible=$API_VERSION" \
          -F "description=${{ env.DESCRIPTION }}"
